# Lua Mirai启动机制

## 基本概念

一个脚本的运行包含两个要素：

一是**脚本环境**

二是**脚本代码**

**脚本环境**是脚本代码的载体，在`LM`中，脚本环境为脚本提供了lua标准库，mirai库等，以及维护了全局变量和在脚本中使用`Event.susbcribe`注册的监听器列表。

**脚本代码**是指具体的lua脚本代码，一般通过文件读取。

通常而言，一个脚本环境可以运行多个脚本代码，但在`LM`中，出于安全考虑，一个脚本代码只分配一个脚本环境，这样很好地避免了不同脚本间发生冲突的可能。

## 脚本的启动过程

1. 初始化脚本环境，为脚本环境注入lua标准库，mirai库等。

2. 使用脚本环境运行代码，运行完毕后，脚本内使用`Event.susbcribe`注册的监听器将由此脚本环境持有。

3. mirai核心在守护进程运行，监听来自bot的事件，并对事件进行分发。
